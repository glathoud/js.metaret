{var need$,read;(function (global){need$ =need$Impl;var has={},inline_workspace={};var readNative=typeof read==='function';need$.read=readNative?read:xhrGetSync;{if (typeof lightparse==='undefined'){(function (global){var RETURN='return',VAR='var',RESERVED_ARR=["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new",RETURN,"switch","this","throw","try","typeof",VAR,"void","while","with","class","const","enum","export","extends","import","super","implements","interface","let","package","private","protected","public","static","yield"],EXTRA_BRACKET_ARR=[{open:RETURN,close:';',typebracket:RETURN,ignore_unbalanced:true},{open:VAR,close:[';','in'],typebracket:VAR,ignore_unbalanced:true}],_emptyObj={};global.lightparse=lightparse;lightparse.getDefaultReservedArr=getDefaultReservedArr;function getDefaultReservedArr(){return[].concat(RESERVED_ARR);}function lightparse(code,opt){'undefined' !==typeof console && console.time && console.time('xxx LP 0');var reservedArr=((opt && opt.reservedArr)|| RESERVED_ARR).concat((opt && opt.extraReservedArr)|| []),extraBracketArr=EXTRA_BRACKET_ARR.concat((opt && opt.extraBracketArr)|| []),ret={strArr:[],commentArr:[],regexpArr:[],reservedArr:[],reservedObj:{},callArr:[],dotArr:[],dotcallArr:[],identifierArr:[],identifierArrReverse:[],identifierObj:{},identifierObjReverse:{},callObj:{},bracketcurlyArr:[],bracketroundArr:[],bracketsquareArr:[],bracketextraArr:[],bracketArr:[],bracketTree:[]};'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 0');'undefined' !==typeof console && console.time && console.time('xxx LP 1');var sA=ret.strArr,cA=ret.commentArr,rxA=ret.regexpArr,nakedCodeArr=[],searchPosition=0 ;while (true){var sq=code.indexOf("'",searchPosition),dq=code.indexOf('"',searchPosition),sc=code.indexOf('/*',searchPosition),dc=code.indexOf('//',searchPosition),rr=code.indexOf('/',searchPosition);if (-1 < rr && !/^\/(?![\*\/])(\\[^\r\n]|[^\\\r\n])+?\/[gmi]?/.test(code.substring(rr)))rr=-1;var four=[sq,dq,sc,dc,rr],begin=+Infinity,ind=-1 ;for(var n=four.length,i=0;i < n;i++){var v=four[i];if (-1 < v && v < begin){begin=v;ind=i;}}if (ind < 0) {nakedCodeArr.push(code.substring(searchPosition));break;}var rest=code.substring(begin),rx=ind===0 ?/^[\s\S]*?[^\\]\'/:ind===1 ?/^[\s\S]*?[^\\]\"/:ind===2 ?/^\/\*[\s\S]*?\*\//:ind===3 ?/^\/\/([^\r\n])*/:/^\/(?![\*\/])(\\[^\r\n]|[^\\\r\n])+?\/[gmi]?/,mo=rx.exec(rest),delta=mo?mo.index+mo[0 ].length:rest.length,end=begin+delta;(ind < 2 ?sA:ind < 4 ?cA:rxA).push({begin:begin,str:code.substring(begin,end)});nakedCodeArr.push(code.substring(searchPosition,begin),str_repli(' ',delta));searchPosition=end;}'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 1');'undefined' !==typeof console && console.time && console.time('xxx LP 2');var reservedSet={};for (var i=reservedArr.length;i--;)reservedSet[reservedArr[i]]= 1;var resA=ret.reservedArr,caA=ret.callArr,dA=ret.dotArr,dcaA=ret.dotcallArr,iA=ret.identifierArr,nakedCode=nakedCodeArr.join(''),rx=/(\.\s*)?(\b[_a-zA-Z]\w*\b)(\s*\()?/g,mo;while (mo=rx.exec(nakedCode)){var str=mo[0 ],dot=mo[1 ],name=mo[2 ],call=mo[3 ],arr=(name in reservedSet?resA:dot && call?dcaA:dot?dA:call?caA:iA),begin=mo.index,x={str:str,begin:begin,name:name};arr.push(x);}'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 2');'undefined' !==typeof console && console.time && console.time('xxx LP 3');var nakedCodeNoRx=nakedCode;for (var i=rxA.length;i--;){var x=rxA[i],len=x.str.length;nakedCodeNoRx=nakedCodeNoRx.substring(0,x.begin)+str_repli(' ',len)+nakedCodeNoRx.substring(x.begin+len);} 'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 3');'undefined' !==typeof console && console.time && console.time('xxx LP 4');var bcA=ret.bracketcurlyArr,brA=ret.bracketroundArr,bsA=ret.bracketsquareArr,beA=ret.bracketextraArr,bA=ret.bracketArr,find_bracket_cfg=[{out_arr:bcA,open:'{',close:'}',typebracket:'curly'},{out_arr:brA,open:'(',close:')',typebracket:'round'},{out_arr:bsA,open:'[',close:']',typebracket:'square'}].concat(extraBracketArr.map(function (x){var ret=Object.create(x);ret.out_arr=beA;return ret;}) );'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 4');'undefined' !==typeof console && console.time && console.time('xxx LP 5');find_bracket(find_bracket_cfg,nakedCodeNoRx,code,bA);build_bracket_tree(bA,ret.bracketTree);build_bracket_sep_split(bA,nakedCodeNoRx,code,reservedArr);build_bracket_var_leftstr_rightstr(bA,cA);'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 5');'undefined' !==typeof console && console.time && console.time('xxx LP 6');var tmp=bA .filter(function (x){return x.typebracket===VAR;}) .reduce(function (a,b){return a.concat(b.sepSplit);},[]);for (var iA_i=0 ,n=tmp.length,niA=iA.length,i=0;i < n && iA_i < niA;i++){var x=tmp[i],id;while ((id=iA[iA_i]).begin < x.begin){id.isVardecl=false;iA_i++;}id.isVardecl=true;iA_i++;}'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 6');'undefined' !==typeof console && console.time && console.time('xxx LP 7');var iA=ret.identifierArr,iR=ret.identifierArrReverse=reversed(iA),vdA=ret.vardeclArr=[],iO=ret.identifierObj={};for (var n=iA.length,i=0;i < n;i++){var x=iA[i];(iO[x.str]!==_emptyObj[x.str]?iO[x.str]:(iO[x.str]=[])).push(x.begin);if (x.isVardecl)vdA.push(x);}var cA=ret.callArr,cO=ret.callObj={};for(var n=cA.length,i=0;i <n;i++){var x=cA[i];(cO[x.name]!==_emptyObj[x.name]?cO[x.name]:(cO[x.name]=[])).push(x.begin);} var iOR=ret.identifierObjReverse={};for (var str in iO){if (!(str in iOR)){iOR[str]=reversed(iO[str]);}} var rA=ret.reservedArr,rO=ret.reservedObj;for (var n=rA.length,i=0;i < n;i++){var x=rA[i];(rO[x.name]!==_emptyObj[x.name]?rO[x.name]:(rO[x.name]=[])).push(x.begin);}'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 7');'undefined' !==typeof console && console.time && console.time('xxx LP 8');var all=ret.all=[];for (var k in ret){var mo=k.match(/^(.+)Arr$/);if (mo){var arr=ret[k],type=mo[1 ];for (var i=arr.length;i--;)arr[i].type=type;all.push.apply(all,arr);}} for (var i=all.length;i--;){var xi=all[i];if (!('end' in xi))xi.end=xi.begin+xi.str.length;}all.sort(compare_begin_end);for (var i=all.length;--i;){var xi=all[i],xim1=all[i-1 ] ;if(xi.begin===xim1.begin && xi.end===xim1.end){if (xi.type !==xim1.type)throw new Error("Internal bug.");all.splice(i,1 ); } } ret.allReverse=reversed(all);var allTree=[].concat(all);for (var i=allTree.length-1;i--;){var xi=allTree[i],xip1;while (xip1=allTree[i+1 ] ,xip1 && xi.begin <=xip1.begin && xip1.end <=xi.end){(xi.children || (xi.children=[])).push(allTree.splice(i+1, 1 )[0 ]);} } ret.allTree=allTree;'undefined' !==typeof console && console.time && console.timeEnd('xxx LP 8');return ret;}function compare_begin (a,b){return a.begin < b.begin?-1 : +1; } function compare_begin_end (a,b){return a.begin < b.begin?-1 :a.begin > b.begin?+1 :a.end > b.end?-1 : +1; } function build_bracket_tree(inArr,outTree){var pile=[];for (var n=inArr.length,i=0;i < n;i++){var x=inArr[i];x.bracketchildren=[];var last;while ((last=pile[pile.length-1]) && last.end < x.begin)pile.pop();x.bracketparent=last?last:null;x.bracketdepth=pile.length;if (last && x.begin < last.end)last.bracketchildren.push(x);else outTree.push(x);pile.push(x);}} function build_bracket_sep_split(bA,nakedCodeNoRx,code,reservedArr){var rx=new RegExp([',',';'].concat(reservedArr.map(function (w){return '\\b'+w+'\\b';}) ) .join('|'),'g');for (var i=bA.length;i--;){var x=bA[i],kids=x.bracketchildren,nakedOne=nakedCodeNoRx.substring(x.begin,x.end),offset=x.begin;;nakedOne=str_repli(' ',x.open.length)+nakedOne.substring(x.open.length,nakedOne.length-x.close.length)+str_repli(' ',x.close.length);for (var j=kids.length;j--;){var kid=kids[j];nakedOne=nakedOne.substring(0,kid.begin-offset)+str_repli(' ',kid.end-kid.begin)+nakedOne.substring(kid.end-offset);} var sA=x.sepArr=[],mo;while (mo=rx.exec(nakedOne))sA.push({index:offset+mo.index,type:mo[0 ]});var FIRST='<first>',LAST='<last>',arr=[{index:offset+x.open.length,type:FIRST}].concat(sA).concat([{index:offset+nakedOne.length-x.close.length,type:LAST}]) ,sS=x.sepSplit=[];for (var n=-1 +arr.length,j=0;j < n;j++){var before=arr[j],after=arr[j+1 ] ,begin=before.index+(before.type !==FIRST && before.type !==LAST?before.type.length:0) ,end=after .index,str=code.substring(begin,end);if (!str)continue;sS.push({begin:begin,end:end,str:str,sep_begin:before,sep_end:after});} } } function build_bracket_var_leftstr_rightstr(bA,commentArr){for (var i=bA.length,i_cA=commentArr.length;i--;){var brack=bA[i];if (brack.typebracket !==VAR)continue;var vdArr=brack.vdArr=[];var s_arr=brack.sepSplit;for(var nj=s_arr.length,j=0;j < nj;j++){var s=s_arr[j],str;if (s.hasOwnProperty('str_noComments')){str=s.str_noComments;}else{str=(/\/\*|\*\//.test(s.str)&& 0 < i_cA && commentArr[i_cA-1 ].end > s.begin?removeComments(s):s.str).replace(/^\s*/,'');if (/^\s$/.test(str.slice(-1 ))){for (var si=str.length-1;si--&& /^\s$/.test(str.charAt(si)););str=str.substring(0,si+1 ); } s.str_noComments=str;}var mo_LR=str.match(/^([^=]*)\s*=\s*([\s\S]+)$/);vdArr.push(mo_LR?{leftstr:mo_LR[1 ],rightstr:mo_LR[2 ]}:{leftstr:str,rightstr:null});} } function removeComments(s){var str=s.str,begin=s.begin,end=s.end;if (0 < i_cA){for (;i_cA--;){var c=commentArr[i_cA];if (c.end > end)continue;if (c.end < begin){i_cA++;break;}str=str.substring(0,c.begin-begin)+str.substring(c.end-begin);}} return str;}}function find_bracket(cfgA,nakedCodeNoRx,code,bA){var rx=new RegExp(cfgA.map(function (o){var open=fix(o.open),close=fix(o.close);return '('+open+')'+'|'+'('+close+')';function fix(x){return 'string'===typeof x?x.replace(/(\W)/g,'\\$1').replace(/^(\w)/,'\\b$1').replace(/(\w)$/,'$1\\b'):x.map(fix).join('|');} } ) .join('|'),'g'),arr=[],mo,error;while (mo=rx.exec(nakedCodeNoRx)){var ind2=-1;for (var i=mo.length;i--;){if (mo[i]){ind2=i-1;break;}} if (!(-1 < ind2))error.bug;var is_close=1 & ind2,cfgA_ind=ind2 >> 1 ;var sanity=cfgA[cfgA_ind][is_close?'close':'open'];if (!('string'===typeof sanity?mo[0]===sanity:-1 < sanity.indexOf(mo[0 ])))error.bug;var one={begin:mo.index,end:mo.index+mo[0 ].length,cfg:cfgA[cfgA_ind]};one[is_close?'close':'open']=mo[0 ];arr.push(one);}var pile=[];for (var n=arr.length,i=0;i < n;i++){var one=arr[i];if (one.open){var x={begin:one.begin,typebracket:one.cfg.typebracket,open:one.cfg.open,close:one.cfg.close};one.cfg.out_arr.push(x);bA .push(x);pile .push({i:i,x:x});}else{var last=pile[pile.length-1 ];if(!last){if (!one.cfg.ignore_unbalanced)throw new Error('Unbalanced brackets: missing an opening "'+one.cfg.open+'".');}else if ('string'===typeof last.x.close?last.x.close !==one.close:0 > last.x.close.indexOf(one.close)){if (!(arr[last.i].cfg.ignore_unbalanced || one.cfg.ignore_unbalanced)){throw new Error('Unbalanced brackets: opening typebracket "'+last.x.typebracket+'" ('+last.x.begin+')'+' does not match closing typebracket "'+one.cfg.typebracket+'" ('+one.begin+').');}} else{var x=pile.pop().x;x.close=one.close;x.end=one.end;x.str=code.substring(x.begin,x.end);}} } if (pile.length !== 0) {var last=pile[pile.length-1 ];global.console && global.console.error("last:",last);throw new Error('Unbalanced brackets: missing a closing "'+last.x.close+'" for {open:"'+last.x.open+'", begin:<char:'+last.x.begin+'>}. Did you forget a semicolon, maybe?');}} function reversed(arr){var ret=[].concat(arr);ret.reverse();return ret;}function str_repli(s,n){return str_filler(s,n)();}function str_trim(s){return s.replace(/(^\s*|\s*$)/g,'');}function str_filler(f,n){if (typeof f==='number'){n=f;f=null;}f=f || ' ';var target=Math.abs(n)*f.length;return function (s){s=s || '';s=s+'';var remaining=Math.max(0,target-s.length),tmp=f,fill=[];for (var p=Math.floor(remaining / f.length)+(((remaining % f.length)> 0) ? 1 : 0);p > 0;tmp+=tmp,p >>= 1) {if (p && 1) fill.push(tmp);}fill=fill.join('');if (fill.length > remaining)fill=(n < 0) ?fill.substring(fill.length-remaining):fill.substring(0,remaining);if (fill.length !==remaining)throw new Error('str.filler() is buggy!');return (n < 0) ?(fill+s):(s+fill);};} })(this);}if(typeof lp2fmtree==='undefined'){(function (global){var METAFUN='metafun',METARET='metaret',FUNCTION='function',RESERVED='reserved',CALL='call',DOTCALL='dotcall',TYPE_BRACKET='bracket',TYPEBRACKET_CURLY='curly';global.lp2fmtree=lp2fmtree;function lp2fmtree(lp,namespace,workspace,parent){var isTopLevel=arguments.length < 2;namespace || (namespace=[]);workspace || (workspace={iAnonymous:0,lastname2fmarr:{}});var at=lp instanceof Array?lp:lp.allTree,ret=[];if(isTopLevel)ret.lastname2fmarr=workspace.lastname2fmarr;for (var n=at.length,i=0;i < n;i++){var one=at[i];var isFunction=one.name===FUNCTION,isMetafunction=one.name===METAFUN,isAnonymousFunction=isFunction && at[i+1 ].type===TYPE_BRACKET;if (((isFunction || isMetafunction)&& at[i+1 ].type !==TYPE_BRACKET)|| isAnonymousFunction){var begin=one.begin,end,dot_arr=[],next;if(isAnonymousFunction){dot_arr=['anonymous#'+(workspace.iAnonymous++)];} else{do{next=at[++i];dot_arr.push(next.name);}while (next.type !==DOTCALL && next.type !==CALL)}var param_arr=(next=at[++i]).sepSplit.map(strip_comment_and_space),param_set={};for (var pi=param_arr.length;pi--;)param_set[param_arr[pi]]= 1;while (next.type !==TYPE_BRACKET || next.typebracket !==TYPEBRACKET_CURLY)next=at[++i];var body_node=next,end=body_node.end,body=body_node.str,fullname_arr=namespace.concat(dot_arr),fullname=fullname_arr.join('.'),lastname=fullname_arr[fullname_arr.length-1 ] ,out={begin:begin,end:end,fullname_arr:fullname_arr,lastname:lastname,isFunction:isFunction,isMetafunction:isMetafunction,isAnonymousFunction:isAnonymousFunction,body_node:body_node,fm_node:one,fullname:fullname,param_arr:param_arr,param_str:param_arr.join(','),param_set:param_set,parent:parent || null,children:null,body:null};var children=next.children?lp2fmtree(next.children,fullname_arr,workspace,out):[];for (var j=children.length;j--;){var kid=children[j],a=kid.begin-body_node.begin,b=kid.end-body_node.begin;if (!kid.isAnonymousFunction)body=body.substring(0,a)+body.substring(a,b).replace(/[\s\S]/g,' ')+body.substring(b);}out.children=children;out.body=body;ret.push(out);if (!isAnonymousFunction){(workspace.lastname2fmarr[lastname]|| (workspace.lastname2fmarr[lastname]=[])).push(out);} } else if (one.children){ret.push.apply(ret,lp2fmtree(one.children,namespace,workspace));} } if(isTopLevel){find_out_who_has_what(ret,[].concat(lp.vardeclArr),'vardecl');find_out_who_has_what(ret,lp.identifierArr.filter(function (x){return !x.isVardecl;}),'varuse');}return ret;}function strip_comment_and_space(o){return o.str.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^\s+|\s+$)/g,'');}function find_out_who_has_what(arr,vArr,outputName){var n=arr.length;for (var i=0;i < n;i++){var one=arr[i],c=one.children;if (c && c.length)find_out_who_has_what(c,vArr,outputName);}for (var i=0;i < n;i++){var one=arr[i],begin=one.begin,end=one.end,one_vda=one[outputName+'Arr']=[],one_vdo=one[outputName+'Obj']={};for (var j=vArr.length;j--;){var vd=vArr[j];if(vd.end < begin)break;if (vd.begin < end){var x=vArr.splice(j,1)[0 ];one_vda.unshift(x);(one_vdo[x.name]|| (one_vdo[x.name]=[])).push(x);}} } } }(this));}if(typeof metaparse==='undefined'){if (typeof lightparse==='undefined'){}if (typeof lp2fmtree==='undefined'){};(function (global){var ACTION_PARAM=0 ,METAFUN='metafun',METARET='metaret',EXTRA_RESERVED_ARR=[METAFUN,METARET],EXTRA_BRACKET_ARR=[{open:METARET,close:';',typebracket:METARET,ignore_unbalanced:true}],LIGHTPARSE_OPT={extraReservedArr:EXTRA_RESERVED_ARR,extraBracketArr:EXTRA_BRACKET_ARR};global.MetaDecl=MetaDecl;global.MetaFunction=MetaFunction;global.metaparse=metaparse;metaparse.get_LIGHTPARSE_OPT=metaparse_get_LIGHTPARSE_OPT;metaparse.get_CONST=metaparse_get_CONST;function metaparse_get_LIGHTPARSE_OPT(){return JSON.parse(JSON.stringify(LIGHTPARSE_OPT));} function metaparse_get_CONST(){return{'METAFUN':METAFUN,'METARET':METARET,'LIGHTPARSE_OPT':metaparse_get_LIGHTPARSE_OPT()};}var _metaparse_rx=/\s*(metafun|function)\s*(\S+)\s*\(\s*([^\)]+?)\s*\)((?![\r\n]\s*(metafun|function))[\s\S])*/g,_metaparse_one_rx=/^\s*(metafun|function)\s*(\S+)\s*\(\s*([^\)]+?)\s*\)\s*\{\s*(((?![\r\n]\s*(metafun|function))[\s\S])*)\s*\}\s*$/,_metaparse_one_start_rx=/^\s*(metafun|function)\s/,_metaparse_one_start_function_rx=/^\s*function\s/;function metaparse(code,name2info,opt){name2info || (name2info=_global_name2info);var noli=code?[code]:document.getElementsByTagName('script'),ret=[];for (var n=noli.length,i=0;i < n;i++){var s=noli[i],sString='string'===typeof s;if (!sString && 'text/js-metaret-decl' !==s.getAttribute('type'))continue;var metacode=sString?s:s.textContent || s.innerText,lp=lightparse(metacode,LIGHTPARSE_OPT),fmtree=lp2fmtree(lp);rec_decl(fmtree,true,name2info,ret,opt);}return ret;}function rec_decl(fmtree,isTop,name2info,output,opt){output || (output=[]);if (fmtree instanceof Array){for (var n=fmtree.length,i=0;i < n;i++)rec_decl(fmtree[i],isTop,name2info,output,opt);}else{if (fmtree.children)rec_decl(fmtree.children,false,name2info,output,opt);name2info[fmtree.fullname]={fm:fmtree,_work_in_progress:true};Decl(fmtree.fullname,fmtree.param_str,fmtree.body,fmtree.children,fmtree.isFunction,name2info,opt);delete name2info[fmtree.fullname]._work_in_progress;if (isTop)output.push({fullname:fmtree.fullname,fmtree:fmtree,info:name2info[fmtree.fullname]}); } return output;}var _global_name2info={};function MetaDecl(code_or_name,param,body,children,name2info,opt){Decl(code_or_name,param,body,children,false,name2info || _global_name2info,opt);}function FunDecl(code_or_name,param,body,children,name2info,opt){Decl(code_or_name,param,body,children,true,name2info || _global_name2info,opt);}function Decl(code_or_name,param,body,children,is_fun,name2info,opt){children || (children=[]);is_fun !=null || (is_fun=_metaparse_one_start_function_rx.test(code_or_name));name2info || (name2info=_global_name2info);var param_null=param==null,body_null=body==null;if (param_null ^ body_null)throw new Error('Decl: invalid usage. Give either both `param` and `body`, or none of them.');if (param_null){var code=_metaparse_one_start_rx.test(code_or_name)?code_or_name:(is_fun?'function':'metafun')+' '+code_or_name,mo=_metaparse_one_rx.exec(code),name=mo[2 ];param=mo[3 ];body=mo[4 ];Decl(name,param,body,children,is_fun,name2info,opt);return;}if (!is_fun){var body_lp=lightparse(body),body_argumentsArr=body_lp.identifierObj['arguments']|| [];if (body_argumentsArr.length)throw new Error('metafun error: it is forbidden to use `arguments` in the body of the metafun (because the body of the metafun may end up being inlined within a `while` loop).');}var name=code_or_name;var dot_arr=name.split('.'),g=name2info===_global_name2info?global:{};while (dot_arr.length > 1) {var next=dot_arr.shift();g=g[next]|| (g[next]={});}var remember=is_fun?'':('\nmetafun '+name+'\n( '+param+')').replace(/([\r\n])/g,'$1// --- ')+'\n\n';g[dot_arr[0 ]]=(is_fun?NormalFunction:MetaFunction)(name,param,remember+body,name2info,children,opt);}function NormalFunction(name,param,body,name2info,children,opt){_checkNameNotUsedYet(name2info,name);if (children && children.length){var rx=/\}\s*/,ok=rx.test(body);body=ok && body.replace(rx,'\n\n'+childrenCode(name2info,children)+'\n\n}')}var info=name2info[name]=name2info[name]|| {};info.name=name;info.lastname=name.replace(/^.*\./,'');info.origParam=param;info.origBody=body;info.name2info=name2info;info.impl=null;info.paramArr=param.split(',');info.body=body;var ret=opt && opt.doNotCompile?fWrapper:getImpl();ret.getInfo=getInfo;ret.getImpl=getImpl;return ret;function fWrapper(){return (info.impl || (info.impl=getImpl())).apply(this,arguments);} function getInfo(){return Object.create(info);}function getImpl(){return info.impl || (info.impl=new Function(param,body));} } function MetaFunction(name,param,body,name2info,children,opt){_checkNameNotUsedYet(name2info,name);var info=name2info[name]=name2info[name]|| {};info.name=name;info.lastname=name.replace(/^.*\./,'');info.origParam=param;info.origBody=body;info.name2info=name2info;info.solved=false;info.newParam=null;info.newBody=null;info.impl=null;var paramArr=info.paramArr=_checkExtractParam(param),varArr=info.varArr=_extractVar(body),metaretArr=info.metaretArr=_checkExtractMetaret(body,paramArr.self,name);_createSolver(info,children);var ret=mfWrapper;if (metaretArr.hasAll(name2info)){info.solve();if (!(opt && opt.doNotCompile))ret=info.compile();}ret.getInfo=mf_getInfo;ret.getImpl=mf_getImpl;return ret;function mfWrapper(){if (!info.impl)info.compile();return info.impl.apply(this,arguments);}function mf_getInfo(){return Object.create(info);}function mf_getImpl(){if (!info.impl)info.compile();return info.impl;}} var _RX_NAME=/^(([a-zA-Z_]\w*|anonymous#\d+)\.)*([a-zA-Z_]\w*|anonymous#\d+)$/,_RX_NAME_ANONYMOUS=/^(([a-zA-Z_]\w*|anonymous#\d+)\.)*(anonymous#\d+)$/,_RX_PARAM=/^((?:^\s*|\s*,\s*)[a-zA-Z_]\w*(?:\s*))+$/,_RX_ACTION=/^[a-zA-Z_]\w*?(\.[a-zA-Z_]\w*?)*$/,_Aps=Array.prototype.slice;function _createSolver(info,children){var name=info.name,metaretArr=info.metaretArr,paramArr=info.paramArr,varArr=info.varArr,origBody=info.origBody,name2info=info.name2info,namespace_arr=name.split('.');info.solve=solve;info.compile=compile;function solve(){if (info.solved)return;if (!metaretArr.hasAll(name2info))throw new Error('MetaFunction : _createSolver : solve() could not resolve all dependencies yet for metafunction "'+name+'".');if (!metaretArr.length)solveNoMetaret();else if (!metaretArr.hasOther())solveSelf();else solveMulti();info.solved=true;}function compile(){if (!info.solved)solve();return info.impl || (info.impl=new Function (info.newParam.join(','),info.newBody));} function solveNoMetaret(){var warn_msg='MetaFunction : _createSolver:solveNoMetaret() no #metaret in body of metafunction "'+name+'".';if ('undefined' !==typeof console && console.warn)console.warn(warn_msg);info.newParam=paramArr;info.newBody=origBody.replace(/^\s+$/mg,'');}function solveSelf(){var against=[paramArr,origBody],label=_generateAddName('L_'+name,against),undefName=_generateAddName('undef',against),newParam=info.newParam=paramArr,i4=_indentGen(4 ),i8=_indentGen(8 ),newBody=info.newBody=i4('var '+undefName+';\n'+label+':while (true) {\n'+i4(_reinitUndef(_replaceMetaretWithContinue(name2info,metaretArr,origBody,label,paramArr),info.varArr,undefName)+'\n')+' return;\n'+'}\n'+(children && children.length?'\n\n'+childrenCode(name2info,children)+'\n':'')).replace(/^\s+$/mg,'');info.paramArr=newParam;info.body=newBody;}function solveMulti(){var maha=metaretArr.hasAll(),infoArr=[info].concat(maha.infoArr.filter(function (other){return other !==info;}) ) ,nameArr=infoArr.map(function (info){return info.name;}) ,against=infoArr.map(function (info){return info.paramArr.concat(info.origBody);}) ,switch_ind_name=nameArr.switch_ind_name=_generateAddName('switch_ind',against),switchLabel=nameArr.switchLabel=_generateAddName('L_switch',against),undefName=_generateAddName('undef',against);check_bound_variables_all_shared(infoArr.map(function (info){return info.fm;}) );var i4=_indentGen(4 ),i8=_indentGen(8 ),i12=_indentGen(12 ),newParam=info.newParam=paramArr,newBody=info.newBody=i4(['var '+undefName+';','var '+switch_ind_name+' =0;',switchLabel+':while (true) {',i4('switch ('+switch_ind_name+'){')].concat(infoArr.map(info2code)).concat([i4('}'),i4('return;'),'}',''].concat(children && children.length?['','',childrenCode(name2info,children .filter(function (kid){(kid.fullname || 0).substring.call.a;return 0 > nameArr.lastIndexOf(kid.fullname);}) )]:[]))).join('\n').replace(/^\s+$/mg,'');function info2code(info,ind){var code=['','case '+ind+':'];code.push(i4(_reinitUndef
(_replaceMetaretWithContinue(name2info,info.metaretArr,info.origBody,nameArr,against),info.varArr,undefName)));code.push('break;');code.push('');return code.map(i8).join('\n');}}} function childrenCode(name2info,children){var arr=[];for (var n=children.length,i=0;i < n;i++){var kid=children[i],info=name2info[kid.fullname];if (kid.isAnonymousFunction)continue;arr.push('\n');arr.push('function '+info.lastname+'('+info.paramArr.join(',')+')\n'+(/^\s*\{[\s\S]*?\}\s*$/.test(info.body)?info.body:('{\n'+info.body+'\n}\n')));} return arr.join('\n');}function _checkNameNotUsedYet(name2info,name){if (!_RX_NAME.test(name))throw new Error('MetaFunction : _checkNameNotUsedYet : Invalid function name "'+name+'". The function name must match [a-zA-Z_][a-zA-Z_0-9]*');if (name2info_has(name2info,name,[]))throw new Error('MetaFunction : _checkNameNotUsedYet : Duplicate function name "'+name+'". The function name must be unique: '+'MetaFunction can be called one time only with a given name.');}function _checkExtractParam(param){param=param.replace(/\/\*.*?\*\//g,'');if (!_RX_PARAM.test(param))throw new Error('MetaFunction : _checkExtractParam : Invalid parameters string, the string must be like "self,x,y,z".');var ret=param.replace(/\s+/g,'').split(',');ret.self=ret.splice(ACTION_PARAM,1 )[0 ];return ret;}function _extractVar(body){var lp=lightparse(body,LIGHTPARSE_OPT),iA=lp.identifierArr,ret=[];for(var n=iA.length,i=0;i < n;i++){var x=iA[i];ret.push({text:x.str,end:x.begin+x.str.length,start:x.begin,isVardecl:x.isVardecl});} return ret;}function _checkExtractMetaret(body,self,selfName){var lp=lightparse(body,LIGHTPARSE_OPT),beA=lp.bracketextraArr,ret=[];ret.body=body;ret.self=self;ret.selfName=selfName;for (var beA_n=beA.length,beA_i=0;beA_i < beA_n;beA_i++){var x=beA[beA_i];if (x.typebracket !==METARET)continue;var exprArr=x.sepSplit.map(function (o){return o.str.replace(/^\s+/,'').replace(/\s+$/,'');}) ,action=exprArr.length > ACTION_PARAM && exprArr.splice(ACTION_PARAM,1 )[0 ];if (!action)throw new Error('MetaFunction : _checkExtractMetaret() : A `metaret` needs at least an action.');if (action !==self && !_RX_ACTION.test(action)){throw new Error('MetaFunction : _checkExtractMetaret : Invalid action "'+action+'". action must be self ("'+self+'") or a named action (like "myOtherAction" or "my.other.action" or "my_other_action").');}var isSelf=action===self || action===selfName;ret.push({exprArr:exprArr,isSelf:isSelf,action:isSelf?selfName:action,end:x.end,start:x.begin,namespace:selfName,namespace_arr:selfName.split('.')}); } ret.hasOther=hasOther;ret.hasAll=hasAll;return ret;}function hasOther(){var cache='hasOtherResult';if (cache in this)return this[cache];var arr=[];for (var i=this.length;i--;){if (!this[i].isSelf)arr.push(this[i].action);}return this[cache]=arr.length && arr;}function hasAll(name2info,visited,visitedObj,visitedArr){var topLevel=arguments.length < 2;if (topLevel){var cache='hasAllResult';if (cache in this)return this[cache];visitedObj={};visitedArr=[];}for (var i=this.length;i--;){var x=this[i];if (x.isSelf)continue;var action=x.action;if (!action)throw new Error('MetaFunction : hasAll : Found a bug: empty metaret action (not permitted).');if (action in visitedObj)continue;var info=name2info_get(name2info,action,x.namespace_arr);if (!info)return false;if (info.name in visitedObj)continue;visitedObj[action]=visitedObj[info.name]=info;visitedArr.push(info);if (!info.metaretArr.hasAll(name2info,visited,visitedObj,visitedArr))return false;}if (topLevel)return this[cache]={vObj:visitedObj,infoArr:visitedArr};else return true;}function _dropAction(paramArr){return paramArr.slice(0,ACTION_PARAM).concat(paramArr.slice(ACTION_PARAM+1 ) ); } function _generateAddName(baseName,against){var newName=_generateName(baseName,against);against.push(newName);return newName;}function _generateName(baseName){var against=_Aps.call(arguments,1 );for (var i=null;true;i=(i >>> 0) + 1) {var label='_'+baseName.replace(/#/g,'').replace(/\W/g,'_')+(i || '')+'_';if (!match(against))return label;}function match(against){if (typeof against==='string')return-1 < against.indexOf(label);for (var i=against.length;i--;){if (match(against[i]))return true;}return false;}} function _replaceMetaretWithContinue(name2info,metaretArr,origBody,label_or_nameArr){var against=_Aps.call(arguments,1 ) ,isLabel=typeof label_or_nameArr==='string',ret=origBody;for (var i=metaretArr.length;i--;){var metaret=metaretArr[i],before=ret.slice(0,metaret.start),after=ret.slice(metaret.end);var after_comment='',after_comment_mo=after.match(/^\s*(?:\/\/[^\r\n]*[\r\n]+|\/\*((?!\*\/)[\s\S]*)\*\/)/);if (after_comment_mo){after_comment=after_comment_mo[0 ];after=after.substring(after_comment.length);}var code=prepareCode(metaret,after_comment);ret=before+code+after;}return ret;function prepareCode(metaret,after_comment){var code=[],info=name2info_get(name2info,metaret.action,metaret.namespace_arr),paramArr=info.paramArr,exprArr=metaret.exprArr;if (paramArr.length !==exprArr.length){throw new Error('MetaFunction : _replaceMetaretWithContinue : prepareCode : Invalid number of metaret arguments, action  "'+metaret.action+'" expects '+paramArr.length+' arguments, but '+exprArr.length+' were given.');}if (paramArr.length===1) {code.push(paramArr[0 ]+'='+exprArr[0 ]+';');}else{for (var j=0,i=0,end=paramArr.length;i < end;i++){var varname=paramArr[i];if (varname===exprArr[i])continue;var newVarname=_generateName(varname,against);against.push(newVarname);code.splice(j++,0,'var '+newVarname+'='+exprArr[i]+';');code.push(varname+'='+newVarname+';');}} if (isLabel){code.push('continue '+label_or_nameArr+';');}else{var nameArr=label_or_nameArr;if (metaret.action===metaretArr.selfName){code.push('continue '+nameArr.switchLabel+';// --- stay in: '+metaret.action);}else{var switch_ind=nameArr.indexOf(info.name);if(0 > switch_ind){throw new Error('MetaFunction : _replaceMetaretWithContinue : prepareCode : Found a bug! Could not find the switch index of action "'+metaret.action+'"');}code.push(nameArr.switch_ind_name+'='+switch_ind+';// --- go to: '+metaret.action);code.push('continue '+nameArr.switchLabel+';');}} if (after_comment)code.unshift(after_comment);code.unshift('{');code.push('}');return code.join('\n')+'\n';}} function _reinitUndef(body,varArr,undefName){var toReinit=[],textSeen={};for (var i=0,i_end=varArr.length;i < i_end;i++){var v=varArr[i],text=v.text;if (text in textSeen)continue;textSeen[text]=1;var maybeDeclInd=body.search(new RegExp(text+'\\s*[,;]'));if (v.isVardecl && -1 < maybeDeclInd && maybeDeclInd < v.end){toReinit.push(text);}} if (!toReinit.length)return body;return 'var '+toReinit.map(function (s){return s+'='+undefName;}).join('\n, ')+(toReinit.length > 1 ?'\n':'')+';\n'+body;}function _indentGen(n){var x=' ',s=[];while(n){if (n & 1) s.push(x);n >>= 1;x+=x;}var s_indent=s.join('');return indentFun;function indentFun(s_or_a){if (typeof s_or_a==='string'){var rxEol=/\n/;if (rxEol.test(s_or_a))return s_or_a.split(rxEol).map(indentFun).join('\n');return s_indent+s_or_a;}return s_or_a.map(indentFun);}}function name2info_has(name2info,name,namespace_arr){var info=name2info_get(name2info,name,namespace_arr);return !!(info && !info._work_in_progress);}function name2info_get(name2info,name,namespace_arr){var fullname=namespace_arr.concat(name).join('.');if (fullname in name2info)return name2info[fullname];if (namespace_arr.length)return name2info_get(name2info,name,namespace_arr.slice(0, -1 ));return false;}function check_bound_variables_all_shared(fmArr){var name2scope={};fmArr.forEach(check_one);function check_one(fm){if (!fm)return;var m_vuo=fm.varuseObj,m_vdo=fm.vardeclObj,m_pset=fm.param_set;for (var name in m_vuo){if (!(name in m_vdo)&& !(name in m_pset)){var scope=decl_scope(name,fm);if (!name2scope[name])name2scope[name]={scope:scope};else if (scope !==name2scope[name].scope)throw new Error('metafun error: when using mutual recursion, the various metafunctions must share their bound variables (if any).');}}} } function decl_scope(name,fm){return fm?(fm.vardeclObj[name]?fm:decl_scope(name,fm.parent)):null;}})(this);}(function (global){global.jsm2js=jsm2js;function jsm2js(jsm_code){var local_name2info={},arr=metaparse(jsm_code,local_name2info,{doNotCompile:true}),ret_js=jsm_code;replace_rec(arr);check_leftover(ret_js);return ret_js;function replace_rec(arr){for (var i=arr.length;i--;){var one=arr[i],fmtree=one.fmtree,info=one.info,begin=fmtree.begin,end=fmtree.end,lastname=info.lastname;begin.toPrecision.call.a;(end || null).toPrecision.call.a;if (fmtree.isMetafunction){ret_js=ret_js.substring(0,begin)+'\nfunction '+info.lastname+'('+info.paramArr.join(',')+')\n{\n'+(info.newBody || (info.solve(),info.newBody))+'\n}\n'+ret_js.substring(end);}else if (fmtree.isFunction){var children=fmtree.children;if (children)replace_rec(children.map(function (kid){return{fmtree:kid,info:local_name2info[kid.fullname]};} ) ); } } } } var CONST;function check_leftover(jscode){CONST || (CONST=metaparse.get_CONST());var lp=lightparse(jscode,CONST.LIGHTPARSE_OPT),fm=lp2fmtree(lp),rO=lp.reservedObj,mfunArr=(rO[CONST.METAFUN]|| []).map(enrich),mretArr=(rO[CONST.METARET]|| []).map(enrich);if (mfunArr.length || mretArr.length){throw new Error('jsm2js:check_leftover: found remaining `metafun` and/or `metaret` within function(s): '+((mfunArr.concat(mretArr).map(function (x){return x.containing_function.fullname;})).join(','))+' - Please check for basic errors. For example a `metaret` can only be used from within a `metafun`.'+' See also github issue #9: https://github.com/glathoud/js.metaret/issues/9');}function enrich(begin){var containing_function;for (var n=fm.length,i=0;i < n;i++){var one_fm=fm[i];if (one_fm.begin <=begin && begin < one_fm.end){containing_function=one_fm;break;}} return{begin:begin,containing_function:containing_function,containing_function_fullname:containing_function && containing_function.fullname,local_context:jscode.substring(Math.max(0,begin-50 ),begin+40 ) }; } } })(this);}{if(typeof lightparse==='undefined'){}if (typeof lp2fmtree==='undefined'){}(function (global){var INLINE='inline',LIGHTPARSE_OPT={extraReservedArr:[INLINE]},VARASSIGN='varassign',ASSIGN='assign',CALL='call',BRACKET='bracket',ROUND='round',IDENTIFIER='identifier',RESERVED='reserved',RETURN='return',VAR='var',VARDECL='vardecl';global.inline=inline;function inline(code,workspace,opt_code_info,error_inline_stack){workspace || (workspace={});error_inline_stack || (error_inline_stack=[]);var lp=lightparse(code,LIGHTPARSE_OPT),fm=lp2fmtree(lp),all=lp.all,inlineArr=all .map(function (o,ind){var ret=getInlineInfo(o,ind,all,code);if (ret){ret.begin=ret.o.begin;ret.end=ret.args.end;ret.str=code.substring(ret.begin,ret.end);}return ret;}).filter(function (info){return info;}) ;var lastname2fmarr=fm.lastname2fmarr;var key=opt_code_info?JSON.stringify(opt_code_info):code;error_inline_stack.push({key:key,code:code,workspace:workspace,opt_code_info:opt_code_info});if(key in workspace){var newcode=workspace[key].newcode;if ('string' !==typeof newcode){if ('undefined' !==typeof console && console && console.error){console.error('error_inline_stack (summary):\n '+error_inline_stack.map(function (x){return '\n'+x.key.substring(0,96)+(x.key.length < 96 ?'':'...');}).join('\n\n###\n'));console.error('error_inline_stack (full):');console.error(error_inline_stack);}throw new Error('inline error: Most likely you have an infinite `inline` recursion. Consider using `metafun` and `metaret` instead.');}return newcode;}workspace[key]={code_info:opt_code_info,inlineArr:inlineArr,lastname2fmarr:lastname2fmarr,lp:lp,fm:fm};if (!inlineArr.length)return workspace[key].newcode=code;for (var i=inlineArr.length;i--;){var one=inlineArr[i];one.fmScopePath=getFmScopePath(fm,one);var local_fmCallMatch=getFmCallMatch(fm,one,one.fmScopePath);if (local_fmCallMatch){one.hasLocalMatch=true;one.fmCallMatch=local_fmCallMatch;one.matchKey=key;}else{var matches=[],callname=one.call.name;(callname || 0).substring.call.a;for (var other_key in workspace){if (workspace.hasOwnProperty(key)){if (key===other_key)continue;var other_stuff=workspace[other_key],other_lastname2fmarr=other_stuff.lastname2fmarr,other_fmarr=other_lastname2fmarr[callname],other_n=other_fmarr && other_fmarr.length;if (other_n===1) {if (one.fmCallMatch){throw new Error('Ambiguous match for inline call "'+callname+'" found between the 2 pieces: '+one.matchKey+'\n --- and --- \n'+other_key);}one.hasLocalMatch=false;one.fmCallMatch=other_fmarr[0 ];one.matchKey=other_key;check_no_local_closure(one.fmCallMatch);}else if (other_n===2) {throw new Error('Ambiguous match for inline call "'+callname+'" found within piece "'+other_key);}}} } if (!one.fmCallMatch)throw new Error('inline error: when inlining within a file, the source body must be visible to the target inline location. one.call.name: "'+one.call.name+'", opt_code_info: '+JSON.stringify(opt_code_info));var matchBegin=one.fmCallMatch.begin,matchEnd=one.fmCallMatch.end,argumentsArr=lp.identifierObj['arguments']|| [];if (argumentsArr.some(function (x){return matchBegin <=x && x < matchEnd;})) throw new Error('inline error: it is forbidden to use `arguments` in the body of the function to be inlined.');}var newcode=code;for (var i=inlineArr.length;i--;){var one=inlineArr[i],begin=one.begin,end=one.end;newcode=newcode.substring(0,begin)+inline(getInlineCodeHygienic(lp.identifierObj,fm,one),workspace,null,error_inline_stack)+newcode.substring(end);} return workspace[key].newcode=newcode;}function getInlineInfo(o,ind,all,code){if (o.name !==INLINE)return;var v,identifier,call,args;if((call=all[ind+1 ]).type===CALL && (args=all[ind+2 ]).type===BRACKET && args.typebracket===ROUND){return{o:o,ind:ind,inlinetype:CALL,call:call,args:args};}if ((identifier=all[ind+1 ]).type===IDENTIFIER && (call=all[ind+2 ]).type===CALL && (args=all[ind+3 ]).type===BRACKET && args.typebracket===ROUND && /=/.test(code.substring(identifier.end,call.begin))){return{o:o,ind:ind,inlinetype:ASSIGN,identifier:identifier,call:call,args:args};}var vc;if((v=all[ind+1 ]).type===BRACKET && v.typebracket===VAR && (vc=v.children).length===4 && (identifier=vc[1 ]).type===VARDECL && (call=vc[2 ]).type===CALL && (args=vc[3 ]).type===BRACKET && args.typebracket===ROUND && /=/.test(code.substring(identifier.end,call.begin))){return{o:o,ind:ind,inlinetype:VARASSIGN,identifier:identifier,call:call,args:args};}throw new Error('Unrecognized inline syntax.');}function getInlineCodeHygienic(identifierObj,fm,one){var error;var fmScopePath=one.fmScopePath,fmCallMatch=one.fmCallMatch;if (-1 < fmScopePath.indexOf(fmCallMatch)){if ('undefined' !==typeof console)console.error('Could not inline: self-recursion found for "'+fmCallMatch.fullname+'".');else if ('undefined' !==typeof print)print('[ERROR] Could not inline: self-recursion found for "'+fmCallMatch.fullname+'".');return one.str.substring(INLINE.length);}var io=Object.create(identifierObj);var undefN=getNewName('undef',io),retN=getNewName('ret',io),param_arr=fmCallMatch.param_arr,paramN_arr=param_arr.map(function (name){return getNewName(name,io);}) ,paramN_map=getMapping(param_arr,paramN_arr),vardeclArr=fmCallMatch.vardeclArr,varnameArr=vardeclArr.map(function (x){return x.name;}) ,vardeclN_arr=varnameArr.map(function (name){return getNewName(name,io);}) ,vardeclN_map=getMapping(varnameArr,vardeclN_arr),body=fmCallMatch.body,body_begin=fmCallMatch.body_node.begin,body_end=fmCallMatch.body_node.end,body_length=body_end-body_begin,toReplace=[],body_lp=lightparse(body,LIGHTPARSE_OPT);for (var i=body_lp.identifierArr.length;i--;){var ident=body_lp.identifierArr[i],newstr=paramN_map[ident.name]|| vardeclN_map[ident.name];if (newstr)toReplace.push({o:ident,newstr:newstr});} for (var i=body_lp.bracketextraArr.length;i--;){var brack=body_lp.bracketextraArr[i];if (brack.typebracket !==RETURN)continue;toReplace.push({o:{begin:brack.begin,end:brack.begin+RETURN.length},newstr:retN+'='});toReplace.push({o:{begin:brack.end,end:brack.end},newstr:' break;'});} toReplace.sort(function (a,b){var error;return a.o.begin < b.o.begin?-1 :a.o.end > b.o.end?+1 :error.bug;});var newbody=body;for (var i=toReplace.length;i--;){var r=toReplace[i];newbody=newbody.substring(0,r.o.begin)+r.newstr+newbody.substring(r.o.end);} var oas=one.args.sepSplit,set_args_arr=paramN_arr.map(function (pN,i){return pN+'='+(i < oas.length?oas[i].str:undefN)+';';});var var_decl_undef_arr=[],var_decl_undef_set={};for (var n=body_lp.bracketextraArr.length,i=0;i < n;i++){var brack=body_lp.bracketextraArr[i];if (brack.typebracket !==VAR)continue;var vdArr=brack.vdArr;for (var nj=vdArr.length,j=0;j < nj;j++){var vd=vdArr[j];if (!vd.rightstr && !(vd.leftstr in var_decl_undef_set)){var_decl_undef_arr.push(vardeclN_map[vd.leftstr]+' ='+undefN);var_decl_undef_set[vd.leftstr]=1; } } } var bodyAlreadyCurly=/^\s*\{[\s\S]*?\}\s*$/.test(newbody);var newcode=['{','//#INLINE_BEGIN: '+one.str.replace(/\r\n/g,' ')].concat(['var '+undefN+','+retN+';']).concat(['//#INLINE_SET_INPUT_ARGS:']).concat(set_args_arr).concat(var_decl_undef_arr.length?['var '+var_decl_undef_arr.join(', ')+';']:[]).concat(['//#INLINE_IMPLEMENT:']).concat(['do {']).concat(newbody).concat(['} while (false);']).concat(one.inlinetype===CALL?[]:one.inlinetype===ASSIGN?[one.identifier.name+'='+retN+';']:one.inlinetype===VARASSIGN?['var '+one.identifier.name+'='+retN+';']:error.bug).concat(['//#INLINE_END: '+one.str.replace(/\r\n/g,' ')]) .concat(['}']).join('\n');return newcode;}function getMapping(arr_in,arr_out){var ret={};for (var i=arr_in.length;i--;)ret[arr_in[i]]=arr_out[i];return ret;}function getNewName(name,io){var base='_'+name+'_',i='',newname;while ((newname=base+i)in io)i=+i+1;io[newname]=1;return newname;}function getFmScopePath(fmtree,one,sofar){sofar || (sofar=[]);for (var n=fmtree.length,i=0;i < n;i++){var fm=fmtree[i];if (fm.begin <=one.begin && one.end <=fm.end){sofar.push(fm);getFmScopePath(fm.children || [],one,sofar);break;}} return sofar;}function getFmCallMatch(fmtree,one,fmScopePath){var callname=one.call.name,all=fmtree.concat(fmScopePath),match;top_loop:for (var i=all.length;i--;){var fm=all[i];var fmc=fm.children || [];for (var j=fmc.length;j--;){var c=fmc[j];if (c.lastname===callname){match=c;break top_loop;}} if (fm.lastname===callname){match=fm;break top_loop;}} if (match)check_bound_variables_all_shared(match,fmScopePath.slice(-1 )[0 ]);return match;}function check_no_local_closure(fm){var vuo=fm.varuseObj,vdo=fm.vardeclObj;for (var name in vuo){if (!(name in vdo)){var pFm=fm;while (pFm=pFm.parent){if (name in pFm.vardeclObj){throw new Error('inline error: when inlining across files, the body to inline MUST NOT use locally bound variables (closures). (It may use globals, though.)');}} }} } function check_bound_variables_all_shared(match,target_inline_fm){var bound=[],m_vuo=match.varuseObj,m_vdo=match.vardeclObj,m_pset=match.param_set;for (var name in m_vuo){if (!(name in m_vdo)&& !(name in m_pset)){bound.push(name);}} bound.forEach(check_declared_in_same_scope);function check_declared_in_same_scope(name){var m_decl_scope=decl_scope(name,match),t_decl_scope=decl_scope(name,target_inline_fm);if (m_decl_scope !==t_decl_scope)throw new Error('inline error: when inlining within a file, the source body and the target inline location must share their bound variables (if the source body has any).');}function decl_scope(name,fm){return fm?(fm.vardeclObj[name]?fm:decl_scope(name,fm.parent)):null;}} })(this);}var canInline=true;function need$Impl(path){if (has[path])return;has[path]=1;var isJsm;if(/\.js$/.test(path))isJsm=false;else if (/\.jsm$/.test(path))isJsm=true;else throw new Error("need$: unknown type, only .js and .jsm are supported. Path: '"+path+"'");var code=need$.read(path);var rx_str="/need\\$\\s*\\(\\s*([\"\\'])([^\"\\']+)\\1/",rx_all=new RegExp(rx_str,"g"),rx_one=new RegExp(rx_str),need_all=code.match(/need\$\s*\(\s*(["\'])([^"\']+)\1/g);while (need_all && need_all.length)need$Impl(need_all.shift().match(/need\$\s*\(\s*(["\'])([^"\']+)\1/)[2]);if (isJsm){code=jsm2js(code);if (canInline)code=inline(code,inline_workspace,{path:path});} eval.call(global,code);}function xhrGetSync(path){var xhr=new XMLHttpRequest();xhr.open("GET",path,false);xhr.send();if (xhr.status !== 0 && xhr.status !== 200) throw new Error("need$:xhrGetSync: Could not load path '"+path+"'");return xhr.responseText+"\r\n//@ sourceURL="+path;}})(this);}
