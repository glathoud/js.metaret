<!DOCTYPE HTML>
<html>
<head>
<title>metaret.js</title>
<script type="text/javascript" src="metaret.js"></script>
<script type="text/js-metaret">
/* I used hash # and double comma ,, so that a full-fledged parser is
 not needed to analyze and unroll the metafunctions into functions.
 */

#metafun fact( #self, #k, #acc )
{
    #acc  ||  (#acc = 1);
    if (#k > 1)
        #metaret #self ,, #k - 1 ,, #acc * #k;
    else
        return #acc;
}

#metafun isEven( #self, #n )
{
    if (#n > 0)
        #metaret isOdd ,, #n - 1;

    if (#n < 0)
        #metaret #self ,, -#n;

    return true;
}

#metafun isOdd( #self, #n )
{
    if (#n > 0)
        #metaret isEven ,, #n - 1;

    if (#n < 0)
        #metaret #self ,, -#n;

    return false; 
}           
</script>
<script type="text/javascript">

// --- Tests with functions declared in script tag(s) with type="text/js-metaret"

metaparse();

assert( "'function' === typeof fact" );
assert( "'function' === typeof isOdd" );
assert( "'function' === typeof isEven" );

assert( '1 == fact(0)' );
assert( '1 == fact(1)' );
assert( '2 == fact(2)' );
assert( '6 == fact(3)' );
assert( '24 == fact(4)' );

assert( 'false === isOdd( -4 )' );
assert( 'true  === isOdd( -3 )' );
assert( 'false === isOdd( -2 )' );
assert( 'true  === isOdd( -1 )' );
assert( 'false === isOdd( 0 )' );
assert( 'true  === isOdd( 1 )' );
assert( 'false === isOdd( 2 )' );
assert( 'true  === isOdd( 3 )' );
assert( 'false === isOdd( 4 )' );
assert( 'true  === isOdd( 1001 )' );
assert( 'false === isOdd( 1002 )' );
assert( 'true  === isOdd( 1000001 )' );
assert( 'false === isOdd( 1000002 )' );
assert( 'true  === isOdd( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'false === isOdd( 10000002 )' );

assert( 'true  === isEven( -4 )' );
assert( 'false === isEven( -3 )' );
assert( 'true  === isEven( -2 )' );
assert( 'false === isEven( -1 )' );
assert( 'true  === isEven( 0 )' );
assert( 'false === isEven( 1 )' );
assert( 'true  === isEven( 2 )' );
assert( 'false === isEven( 3 )' );
assert( 'true  === isEven( 4 )' );
assert( 'false === isEven( 1001 )' );
assert( 'true  === isEven( 1002 )' );
assert( 'false === isEven( 1000001 )' );
assert( 'true  === isEven( 1000002 )' );
assert( 'false === isEven( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'true  === isEven( 10000002 )' );

// --- Similar tests as above, with functions declared programmatically

MetaDecl
( 
    'fact2'   
    , '#self,#k,#acc'
    , [ 
        '#acc  ||  (#acc = 1);'
        , 'if (#k > 1)'
        , '    #metaret #self ,, #k - 1 ,, #acc * #k;'
        , 'else'
        , '    return #acc;'
    ].join( '\n' )
);

assert( '1 == fact2(0)' );
assert( '1 == fact2(1)' );
assert( '2 == fact2(2)' );
assert( '6 == fact2(3)' );
assert( '24 == fact2(4)' );

MetaDecl  // Let us try the "one string" variant
(
      '#metafun isEven2 ( #self, #n ) {'
      + ' if (#n > 0)'
      + '    #metaret isOdd2 ,, #n - 1;'
      + 'if (#n < 0)'
      + '    #metaret #self ,, -#n;'
      + 'return true;'
      + '}'
);

MetaDecl  // Let us try the "one string" variant with "#metafun" omitted
(
      'isOdd2(#self,#n) {'
      + 'if (#n > 0)'
      + '    #metaret isEven2 ,, #n - 1;'
      + 'if (#n < 0)'
      + '    #metaret #self ,, -#n;'
      + 'return false;'
      + '}'
);

assert( 'false === isOdd2( -4 )' );
assert( 'true  === isOdd2( -3 )' );
assert( 'false === isOdd2( -2 )' );
assert( 'true  === isOdd2( -1 )' );
assert( 'false === isOdd2( 0 )' );
assert( 'true  === isOdd2( 1 )' );
assert( 'false === isOdd2( 2 )' );
assert( 'true  === isOdd2( 3 )' );
assert( 'false === isOdd2( 4 )' );
assert( 'true  === isOdd2( 1001 )' );
assert( 'false === isOdd2( 1002 )' );
assert( 'true  === isOdd2( 1000001 )' );
assert( 'false === isOdd2( 1000002 )' );
assert( 'true  === isOdd2( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'false === isOdd2( 10000002 )' );

assert( 'true  === isEven2( -4 )' );
assert( 'false === isEven2( -3 )' );
assert( 'true  === isEven2( -2 )' );
assert( 'false === isEven2( -1 )' );
assert( 'true  === isEven2( 0 )' );
assert( 'false === isEven2( 1 )' );
assert( 'true  === isEven2( 2 )' );
assert( 'false === isEven2( 3 )' );
assert( 'true  === isEven2( 4 )' );
assert( 'false === isEven2( 1001 )' );
assert( 'true  === isEven2( 1002 )' );
assert( 'false === isEven2( 1000001 )' );
assert( 'true  === isEven2( 1000002 )' );
assert( 'false === isEven2( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'true  === isEven2( 10000002 )' );

// ---

console.log('All tests passed.');

// ---

function assert(codestring) { if (!eval( codestring )) throw new Error( 'Failed test: ' + codestring ); }

</script>
</head>
<body>
</body>
</html>
