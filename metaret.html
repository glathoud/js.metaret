<!DOCTYPE HTML>
<html>
<head>
<title>metaret.js</title>
<script type="text/javascript" src="lightparse.js"></script>
<script type="text/javascript" src="metaret.js"></script>
<script type="text/js-metaret-decl" id="metaret-decls">
/* 

type="js-metaret-decl": meta-function declarations, using JavaScript
augmented with two extra keywords `metaret` and `metafun`.

`metaret` uses the hash symbol "#" as separator instead of comma ","
so that a full parser is not needed (./lightparse.js suffices).

`metaret` is not a function call, but rather metacomposition,
implemented here through hygienic inlining. Details: ./metaret.js

*/

metafun fact( self, k, acc )
{
    acc  ||  (acc = 1);
    if (k > 1)
        metaret self # k - 1 # acc * k;
    else
        return acc;
}

metafun isEven( self, n )
{
    if (n > 0)
        metaret isOdd # n - 1;

    if (n < 0)
        metaret self # -n;

    return true;
}

metafun isOdd( self, n )
{
    if (n > 0)
        metaret isEven # n - 1;

    if (n < 0)
        metaret self # -n;

    return false; 
}           
</script>
<script type="text/javascript" id="metaret-tests">
// --- Tests with functions declared in script tag(s) with type="text/js-metaret-decl"

metaparse();

assert( "'function' === typeof fact" );
assert( "'function' === typeof isOdd" );
assert( "'function' === typeof isEven" );

assert( '1 == fact(0)' );
assert( '1 == fact(1)' );
assert( '2 == fact(2)' );
assert( '6 == fact(3)' );
assert( '24 == fact(4)' );

assert( 'false === isOdd( -4 )' );
assert( 'true  === isOdd( -3 )' );
assert( 'false === isOdd( -2 )' );
assert( 'true  === isOdd( -1 )' );
assert( 'false === isOdd( 0 )' );
assert( 'true  === isOdd( 1 )' );
assert( 'false === isOdd( 2 )' );
assert( 'true  === isOdd( 3 )' );
assert( 'false === isOdd( 4 )' );
assert( 'true  === isOdd( 1001 )' );
assert( 'false === isOdd( 1002 )' );
assert( 'true  === isOdd( 1000001 )' );
assert( 'false === isOdd( 1000002 )' );
assert( 'true  === isOdd( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'false === isOdd( 10000002 )' );

assert( 'true  === isEven( -4 )' );
assert( 'false === isEven( -3 )' );
assert( 'true  === isEven( -2 )' );
assert( 'false === isEven( -1 )' );
assert( 'true  === isEven( 0 )' );
assert( 'false === isEven( 1 )' );
assert( 'true  === isEven( 2 )' );
assert( 'false === isEven( 3 )' );
assert( 'true  === isEven( 4 )' );
assert( 'false === isEven( 1001 )' );
assert( 'true  === isEven( 1002 )' );
assert( 'false === isEven( 1000001 )' );
assert( 'true  === isEven( 1000002 )' );
assert( 'false === isEven( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'true  === isEven( 10000002 )' );

// --- Tests with functions declared programmatically

// - Test the local `name2info`

// For test purposes: same name 'fact2' as used below, 
// but different function (just a sum)
//
// Since we are using a `local_name2info`
// there must not be any impact on the 
// global declaration 'fact2` further below

var local_name2info = {}
,   local_fun = MetaFunction(
        'fact2' 

        , 'self,k,acc'

        , 'acc ||  (acc = 0);  '
          + 'if (k > 0)  metaret  self # k-1 # acc + k;'  // sum
          + 'else        return acc;'

        , local_name2info
      )
;

assert( '0 === local_fun( 0 )' );
assert( '1 === local_fun( 1 )' );
assert( '3 === local_fun( 2 )' );
assert( '6 === local_fun( 3 )' );
assert( '10 === local_fun( 4 )' );
assert( '10000*10001/2 === local_fun( 10000 )' );  // No stack issue because the code has been unrolled

// - Test global declarations with dotted names. 

// For test purposes: same name 'fact2' as used above and below, but
// different implementation (sum of squares).
//
// Since we are using a name space 'some.name.space' there must not be
// any impact on the above local declaration, and on the similarly
// named global declarations below.

MetaDecl( 'some.name.space.fact2'
          , 'self, k, acc'
          , 'acc  ||  (acc = 0);'
          + 'if (k > 0)  metaret  self # k-1 # acc + k * k;'  // sum of squares
          + 'else        return acc;'
        );

assert( '0 === some.name.space.fact2( 0 )' );
assert( '1 === some.name.space.fact2( 1 )' );
assert( '5 === some.name.space.fact2( 2 )' );
assert( '14 === some.name.space.fact2( 3 )' );
assert( '30 === some.name.space.fact2( 4 )' );
assert( '10000 * 10001 * 20001 / 6 === some.name.space.fact2( 10000 )' ) // No stack issue because the code has been unrolled

// - Test global declarations 'fact2', 'isEven2' and 'isOdd2'
//   These implementations are similar as those in the script tag
//   (see above, at the beginning).

MetaDecl
( 
    'fact2'   
    , 'self,k,acc'
    , [ 
        'acc  ||  (acc = 1);'
        , 'if (k > 1)'
        , '    metaret self # k - 1 # acc * k;'  // factorial
        , 'else'
        , '    return acc;'
    ].join( '\n' )
);

assert( '1 == fact2(0)' );
assert( '1 == fact2(1)' );
assert( '2 == fact2(2)' );
assert( '6 == fact2(3)' );
assert( '24 == fact2(4)' );

MetaDecl  // Let us try the "one string" variant
(
      'metafun isEven2 ( self, n ) {'
      + ' if (n > 0)'
      + '    metaret isOdd2 # n - 1;'
      + 'if (n < 0)'
      + '    metaret self # -n;'
      + 'return true;'
      + '}'
);

MetaDecl  // Let us try the "one string" variant with "metafun" omitted
(
      'isOdd2(self,n) {'
      + 'if (n > 0)'
      + '    metaret isEven2 # n - 1;'
      + 'if (n < 0)'
      + '    metaret self # -n;'
      + 'return false;'
      + '}'
);

assert( 'false === isOdd2( -4 )' );
assert( 'true  === isOdd2( -3 )' );
assert( 'false === isOdd2( -2 )' );
assert( 'true  === isOdd2( -1 )' );
assert( 'false === isOdd2( 0 )' );
assert( 'true  === isOdd2( 1 )' );
assert( 'false === isOdd2( 2 )' );
assert( 'true  === isOdd2( 3 )' );
assert( 'false === isOdd2( 4 )' );
assert( 'true  === isOdd2( 1001 )' );
assert( 'false === isOdd2( 1002 )' );
assert( 'true  === isOdd2( 1000001 )' );
assert( 'false === isOdd2( 1000002 )' );
assert( 'true  === isOdd2( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'false === isOdd2( 10000002 )' );

assert( 'true  === isEven2( -4 )' );
assert( 'false === isEven2( -3 )' );
assert( 'true  === isEven2( -2 )' );
assert( 'false === isEven2( -1 )' );
assert( 'true  === isEven2( 0 )' );
assert( 'false === isEven2( 1 )' );
assert( 'true  === isEven2( 2 )' );
assert( 'false === isEven2( 3 )' );
assert( 'true  === isEven2( 4 )' );
assert( 'false === isEven2( 1001 )' );
assert( 'true  === isEven2( 1002 )' );
assert( 'false === isEven2( 1000001 )' );
assert( 'true  === isEven2( 1000002 )' );
assert( 'false === isEven2( 10000001 )' );   // No stack issue because the code has been unrolled
assert( 'true  === isEven2( 10000002 )' );

// --- Test again `local_fun` to make sure it as not been affected by the global declaration `fact2`

assert( '0 === local_fun( 0 )' );
assert( '1 === local_fun( 1 )' );
assert( '3 === local_fun( 2 )' );
assert( '6 === local_fun( 3 )' );
assert( '10 === local_fun( 4 )' );
assert( '10000*10001/2 === local_fun( 10000 )' );  // No stack issue because the code has been unrolled

// --- Test again `some.name.space.fact2` to make sure it as not been affected by the global declaration `fact2`

assert( '0 === some.name.space.fact2( 0 )' );
assert( '1 === some.name.space.fact2( 1 )' );
assert( '5 === some.name.space.fact2( 2 )' );
assert( '14 === some.name.space.fact2( 3 )' );
assert( '30 === some.name.space.fact2( 4 )' );
assert( '10000 * 10001 * 20001 / 6 === some.name.space.fact2( 10000 )' ) // No stack issue because the code has been unrolled

// ---

console.log('All tests passed.');

// ---

function assert(codestring) { if (!eval( codestring )) throw new Error( 'Failed test: ' + codestring ); }
</script>
</head>
<body>

<h3>Metafunction declarations</h3>
<pre class="prettyprint lang-js"><code><script type="text/javascript">
      (function () {
        var s = document.getElementById('metaret-decls');
        document.write('&lt;script type="' + s.getAttribute('type') + '" id="' + s.getAttribute('id') + '"&gt;\n');
        document.write('\x3Cspan class="prettyprint lang-js"\x3E' + s.textContent + '\x3C/span\x3E');
        document.write('\n&lt;/script&gt;');
      })();
</script></code></pre>

<h3>Tests</h3>
<pre class="prettyprint lang-js"><code><script type="text/javascript">
      (function () {
        var s = document.getElementById('metaret-tests');
        document.write('&lt;script type="' + s.getAttribute('type') + '" id="' + s.getAttribute('id') + '"&gt;\n');
        document.write(s.textContent);
        document.write('\n&lt;/script&gt;');
      })();
</script></code></pre>


<link href="prettify/prettify.css" type="text/css" rel="stylesheet"/>
<script type="text/javascript" src="prettify/prettify.js"></script>
<script type="text/javascript">setTimeout( prettyPrint );</script>

</body>
</html>
